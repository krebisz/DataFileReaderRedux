using Newtonsoft.Json.Linq;
using System.Text.RegularExpressions;
using static System.Net.Mime.MediaTypeNames;

namespace DataFileReader.Class;

public class HierarchyObjectList
{
    public HierarchyObjectList()
    {
        HierarchyObjects = new List<HierarchyObject>();
    }

    public List<HierarchyObject> HierarchyObjects { get; set; }

    public void GenerateMetaIDs()
    {
        foreach (var hierarchyObject in HierarchyObjects)
        {
            var type = hierarchyObject.Value.GetType();

            if (string.IsNullOrEmpty(hierarchyObject.Name)) hierarchyObject.Name = Guid.NewGuid().ToString();

            hierarchyObject.Fields.Add(hierarchyObject.Value, type);
            hierarchyObject.GenerateMetaDataID();
        }
    }


    public void Add(string path, JToken jToken, string classID)
    {
        HierarchyObject hierarchyObject = new HierarchyObject();

        string[] pathParts = path.Split('.');


        hierarchyObject.ID = HierarchyObjects.Count + 1; // Simple ID generation
        hierarchyObject.Name = pathParts.Last();

        hierarchyObject.ParentID = FindParentID(pathParts); // Default parent ID, can be adjusted later
        hierarchyObject.Level = FindLevel(hierarchyObject.ParentID); // Default level, can be adjusted later
        hierarchyObject.ClassID = classID;

        if (classID != "Element")
        {
            hierarchyObject.Value = "";
        }
        else
        {
            hierarchyObject.Value = jToken.ToString();
        }


            hierarchyObject.MetaDataID = null; // Default MetaDataID, can be set later
        hierarchyObject.Fields = new Dictionary<string, Type>();
        //hierarchyObject.Element = new KeyValuePair<string, JsonNode?>(path, jToken as JsonNode);

        HierarchyObjects.Add(hierarchyObject);
    }


    public void Add(HierarchyObject hierarchyObject)
    {
        HierarchyObjects.Add(hierarchyObject);
    }

    public void AddRange(IEnumerable<HierarchyObject> hierarchyObjects)
    {
        HierarchyObjects.AddRange(hierarchyObjects);
    }

    public void Clear()
    {
        HierarchyObjects.Clear();
    }

    public int? FindParentID(string[] pathParts)
    {
        string objectName = pathParts.Last();
        string? parentName = pathParts.Length > 1 ? pathParts[pathParts.Length - 2] : null;

        if (parentName is null)
        {
            string[] parts = Regex.Split(objectName, @"\[.*?\]");
            // If the last part is an index, we need to find the parent name from the previous part
            if (parts.Length > 1)
            {
                parentName = parts[parts.Length - 2];
            }
        }
        if (parentName is null)
        {
            return null; // No parent name found
        }

        return HierarchyObjects.FirstOrDefault(h => h.Name == parentName).ID;

        //string? parentName = pathParts.Length > 1 ? pathParts[pathParts.Length - 2] : null;

        //if (parentName is null)
        //{
        //    return null; // No path parts provided
        //}

        //return HierarchyObjects.FirstOrDefault(h => h.Name == parentName).ID;
    }

    public int? FindLevel(int? parentID)
    {
        int level = 0;

        if (parentID != null)
        {
            level = (int)HierarchyObjects.FirstOrDefault(h => h.ID == parentID).Level + 1;
        }

        return level;
    }
}